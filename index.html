import { getAuth, onAuthStateChanged } from "firebase/auth";

const auth = getAuth();

onAuthStateChanged(auth, (user) => {
  if (!user) {
    // Se NÃO houver usuário logado, manda de volta para o login
    window.location.href = "/login.html";
  } else {
    // Usuário logado! Aqui você pode carregar os dados bancários dele
    console.log("Acessando dados de: ", user.email);
  }
});
});<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caroline Medeiros - Organizador Premium</title>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet (Mapas Reais) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --chocolate: #3E2723;
            --chocolate-light: #5D4037;
            --off-white: #FDFBF7;
            --gold: #C5A059;
            --gold-light: #E0C080;
            --text-main: #3E2723;
            --success: #558B2F;
            --danger: #C62828;
            --bg-card: #FFFFFF;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow: 0 10px 30px -5px rgba(62, 39, 35, 0.1);
            --shadow-hover: 0 15px 35px -5px rgba(197, 160, 89, 0.2);
            --period-line: #C5A059; 
            --heart-safe: #C5A059; 
            --heart-unsafe: #3E2723;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', 'Segoe UI', sans-serif; }
        h1, h2, h3, .monogram { font-family: 'Playfair Display', 'Georgia', serif; }

        body {
            background-color: var(--off-white);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(62, 39, 35, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

        /* --- Header --- */
        header {
            padding: 20px 20px 15px; text-align: center;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(197, 160, 89, 0.2);
            position: sticky; top: 0; z-index: 50;
        }
        .monogram { font-size: 2.2rem; letter-spacing: 2px; color: var(--chocolate); line-height: 1; }
        .brand-name { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 3px; color: var(--gold); font-weight: 700; margin-top: 4px; }
        .date-time-display { font-size: 0.75rem; color: #8D6E63; margin-top: 8px; font-weight: 500; }

        /* --- Navigation --- */
        .navigation-bar { padding: 10px 5%; background: #fff; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0; overflow-x: auto; white-space: nowrap; }
        .breadcrumb-item { cursor: pointer; color: var(--chocolate-light); font-weight: 600; display: flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; transition: var(--transition); }
        .breadcrumb-item:hover { background: #f5f5f5; color: var(--gold); }

        /* --- Main --- */
        main { flex: 1; padding: 25px 5%; max-width: 1200px; margin: 0 auto; width: 100%; position: relative; animation: fadeIn 0.4s ease-out; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; position: relative; z-index: 20; }
        .section-header h2 { color: var(--chocolate); }

        /* --- Cards --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--bg-card); padding: 25px; border-radius: 24px; border: 1px solid rgba(0,0,0,0.03); box-shadow: var(--shadow); cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 15px; position: relative; overflow: visible; }
        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); border-color: rgba(197, 160, 89, 0.3); }
        .card.selected { border: 2px solid var(--success); background-color: #F1F8E9; }
        .card.selection-mode { cursor: pointer; }
        .selection-check { position: absolute; top: 15px; right: 15px; color: var(--success); display: none; }
        .card.selected .selection-check { display: block; }

        /* --- Buttons --- */
        .btn-add { background: var(--chocolate); color: white; border: none; padding: 10px 24px; border-radius: 30px; cursor: pointer; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(62, 39, 35, 0.2); transition: 0.2s; }
        .btn-add:hover { background: var(--chocolate-light); transform: translateY(-1px); }
        .btn-cancel { background: #f5f5f5; color: #666; border: 1px solid #eee; padding: 10px 24px; border-radius: 30px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s; }
        .btn-cancel:hover { background: #e0e0e0; }
        .btn-check { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; cursor: pointer; color: transparent; transition: 0.2s; }
        .btn-check.active { background: var(--success); border-color: var(--success); color: white; }

        /* --- Floating Dashboard Button --- */
        .floating-star-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--gold); border-radius: 50%; box-shadow: 0 10px 30px rgba(197, 160, 89, 0.5); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; animation: pulse-gold 3s infinite; transition: transform 0.3s; }
        .floating-star-btn:hover { transform: scale(1.1) rotate(15deg); }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(197, 160, 89, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(197, 160, 89, 0); } 100% { box-shadow: 0 0 0 0 rgba(197, 160, 89, 0); } }

        /* --- Modals --- */
        #modal-overlay, #delete-modal-overlay, #report-modal-overlay, #file-preview-modal, #share-modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(62, 39, 35, 0.4); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s; }
        #modal-overlay.open, #delete-modal-overlay.open, #report-modal-overlay.open, #file-preview-modal.open, #share-modal.open { opacity: 1; }
        .modal { background: white; padding: 35px; border-radius: 24px; width: 90%; max-width: 480px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal.large { max-width: 600px; }
        #modal-overlay.open .modal, #delete-modal-overlay.open .modal, #report-modal-overlay.open .modal, #file-preview-modal.open .modal, #share-modal.open .modal { transform: scale(1); }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 0.8rem; margin-bottom: 8px; color: var(--chocolate); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 12px; font-size: 0.95rem; background: #fafafa; outline: none; }
        .form-control:focus { border-color: var(--gold); background: #fff; box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1); }
        textarea.form-control { min-height: 120px; resize: vertical; }

        /* --- Menus --- */
        .create-menu-container { position: relative; }
        .create-menu-dropdown { position: absolute; top: 110%; right: 0; background: white; border: 1px solid #f0f0f0; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 240px; display: none; z-index: 1000; overflow: hidden; animation: fadeIn 0.1s ease; }
        .create-menu-dropdown.show { display: block; }
        .create-menu-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 0.9rem; color: #555; transition: 0.2s; }
        .create-menu-item:hover { background: #fdfaf5; color: var(--chocolate); padding-left: 25px; }

        /* --- Toasts --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 15px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; font-size: 0.9rem; font-weight: 600; border-left: 4px solid #333; animation: slideInRight 0.3s; }
        .toast.success { border-color: var(--success); color: var(--success); }
        .toast.error { border-color: var(--danger); color: var(--danger); }

        /* --- Module Specifics --- */
        .summary-card { background: linear-gradient(135deg, var(--chocolate), #2D1B18); color: white; padding: 25px; border-radius: 16px; margin-bottom: 25px; display: flex; justify-content: space-around; text-align: center; }
        .summary-item b { display: block; font-size: 1.4rem; color: var(--gold); margin-top: 5px; }
        .finance-list { background: #fff; border-radius: 16px; overflow: hidden; border: 1px solid #f9f9f9; }
        .finance-item { display: grid; grid-template-columns: 50px 1fr auto 40px; padding: 20px; border-bottom: 1px solid #f0f0f0; align-items: center; }
        .finance-item.paid { background-color: #fafafa; }
        .finance-item.paid .item-text, .finance-item.paid .amount { opacity: 0.4; text-decoration: line-through; }
        .piggy-card { background: white; border-radius: 20px; padding: 25px; box-shadow: var(--shadow); }
        .progress-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 3px; margin: 15px 0; }
        .progress-block { height: 8px; background: #f0f0f0; border-radius: 2px; }
        .progress-block.filled { background: var(--gold); }
        .gps-map-container { width: 100%; height: 180px; background: #e0e0e0; border-radius: 16px; overflow: hidden; position: relative; z-index: 1; }
        #gps-map { width: 100%; height: 100%; }
        .gps-overlay-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px 0; text-align: center; }
        .gps-stat-value { font-size: 1.5rem; font-weight: 800; color: var(--chocolate); }
        .weight-progress-bar { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .weight-progress-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.5s ease; }
        .weight-detail-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin: 15px 0; }
        .weight-detail-table td { padding: 8px 0; border-bottom: 1px solid #f5f5f5; color: #555; }
        .weight-detail-table td:last-child { text-align: right; font-weight: 600; color: var(--chocolate); }
        .history-list { max-height: 200px; overflow-y: auto; margin-top: 15px; border-top: 1px solid #eee; }
        .history-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f9f9f9; font-size: 0.9rem; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; margin-top: 10px; }
        .cal-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; text-align: center; font-size: 0.65rem; font-weight: 700; color: var(--chocolate); margin-bottom: 5px; }
        .cal-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.8rem; color: #555; cursor: pointer; position: relative; border: 1px solid transparent; }
        .cal-day:hover { background: #fDFBF7; border-color: var(--gold); }
        .cal-day.today { font-weight: 800; color: var(--chocolate); border-color: var(--chocolate); }
        .cal-line { width: 20px; height: 3px; background: transparent; margin-top: 2px; border-radius: 2px; }
        .cal-day.period-active .cal-line { background: var(--period-line); width: 26px; } 
        .cal-day.predicted .cal-line { border-bottom: 1px dashed var(--period-line); height: 0; }
        .cal-star { position: absolute; top: 1px; right: 1px; width: 10px; height: 10px; background: var(--gold); clip-path: polygon(50% 0%, 61% 35%, 100% 50%, 61% 65%, 50% 100%, 39% 65%, 0% 50%, 39% 35%); }
        .cal-heart { font-size: 0.6rem; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); }
        .alert-card { background: #FFF8E1; border-left: 4px solid var(--gold); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.9rem; }
        .alert-card.danger { background: #FFEBEE; border-color: var(--danger); color: var(--danger); }
        .verse-card { background: transparent; border: 1px solid rgba(197, 160, 89, 0.2); padding: 12px 15px; margin-bottom: 20px; border-radius: 12px; font-size: 0.85rem; color: #666; display: flex; flex-direction: column; gap: 4px; }
        .verse-text { font-family: 'Georgia', serif; font-style: italic; color: var(--chocolate); line-height: 1.4; }
        .verse-ref { font-weight: 700; font-size: 0.7rem; color: var(--gold); text-transform: uppercase; text-align: right; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .report-table th, .report-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .report-table th { color: var(--chocolate); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; }
        
        #file-preview-content iframe { width: 100%; height: 500px; border: none; background: #eee; }
        #file-preview-content img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
        
        /* Time Navigation */
        .time-navigator { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .nav-btn { background: white; border: 1px solid #eee; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--chocolate); }
        .nav-btn:hover { background: var(--gold); color: white; border-color: var(--gold); }
        .current-date-label { font-family: 'Playfair Display', serif; font-size: 1.2rem; color: var(--chocolate); min-width: 180px; text-align: center; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

<div id="loading-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--off-white); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
    <div class="monogram" style="font-size: 2rem;">CM</div>
    <div class="brand-name" style="margin-top:10px; opacity:0.6">Carregando...</div>
</div>

<div id="toast-container"></div>

<header>
    <div class="monogram">CM</div>
    <div class="brand-name">Caroline Medeiros</div>
    <div class="date-time-display" id="clock-display">...</div>
</header>

<div class="navigation-bar" id="breadcrumb-container"></div>

<main id="main-content"></main>

<!-- CREATE/EDIT MODAL -->
<div id="modal-overlay">
    <div class="modal">
        <h3 id="modal-title" style="text-align:center; margin-bottom: 25px; color: var(--chocolate); font-family: 'Playfair Display', serif;">Adicionar</h3>
        <div id="modal-form"></div>
        <div id="modal-actions" style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;"></div>
    </div>
</div>

<!-- FILE PREVIEW MODAL -->
<div id="file-preview-modal">
    <div class="modal large">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h3 style="color:var(--chocolate); font-family: 'Playfair Display', serif;" id="preview-filename">Arquivo</h3>
            <div style="display:flex; gap:10px">
                <a id="preview-download-btn" class="btn-add" style="padding:6px 12px; font-size:0.8rem; text-decoration:none"><i data-lucide="download" style="width:16px"></i> Download</a>
                <button onclick="window.closePreviewModal()" style="background:none; border:none; cursor:pointer"><i data-lucide="x"></i></button>
            </div>
        </div>
        <div id="file-preview-content" style="max-height:60vh; overflow-y:auto; text-align:center;"></div>
        <div id="preview-caption" style="margin-top:15px; font-style:italic; color:#666; text-align:center;"></div>
    </div>
</div>

<!-- SHARE MODAL -->
<div id="share-modal">
    <div class="modal">
        <h3 style="text-align:center; color:var(--chocolate); font-family:'Playfair Display',serif; margin-bottom:20px">Compartilhar Item</h3>
        <div style="background:#f9f9f9; padding:15px; border-radius:12px; border:1px solid #eee; margin-bottom:20px; font-size:0.9rem; word-break:break-all; color:#666" id="share-link-display"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <button class="btn-add" style="justify-content:center" onclick="window.copyShareLink()"><i data-lucide="copy"></i> Copiar Link</button>
            <button class="btn-add" style="justify-content:center; background:#25D366" onclick="window.shareDirectly()"><i data-lucide="share-2"></i> Enviar</button>
        </div>
        <button class="btn-cancel" style="width:100%; margin-top:15px" onclick="document.getElementById('share-modal').classList.remove('open'); setTimeout(()=>document.getElementById('share-modal').style.display='none',300)">Fechar</button>
    </div>
</div>

<!-- DELETE CONFIRMATION MODAL -->
<div id="delete-modal-overlay">
    <div class="modal" style="text-align: center;">
        <div style="display:flex; justify-content:center; margin-bottom:15px">
            <div style="width:60px; height:60px; background:#FFEBEE; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--danger)">
                <i data-lucide="alert-triangle" style="width:30px; height:30px"></i>
            </div>
        </div>
        <h3 style="color: var(--danger); margin-bottom: 10px;">Exclusão</h3>
        <p id="delete-modal-text" style="margin-bottom: 25px; color: #666; line-height: 1.5;">Tem certeza que deseja apagar este item?</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn-cancel" onclick="window.closeDeleteModal()">Cancelar</button>
            <button class="btn-add" style="background:var(--danger)" id="confirm-delete-btn" onclick="window.confirmDelete()">Confirmar</button>
        </div>
    </div>
</div>

<!-- BATCH ACTION BAR -->
<div id="batch-actions-bar" style="position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 150px); background: var(--chocolate); color: white; padding: 15px 30px; border-radius: 40px; display: flex; align-items: center; gap: 20px; z-index: 5000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: transform 0.3s;">
    <span id="selected-count" style="font-weight:600">0 selecionados</span>
    <button onclick="window.confirmBatchDelete()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:8px 16px; border-radius:20px; cursor:pointer; font-size:0.85rem">Excluir</button>
    <button onclick="window.toggleSelectionMode()" style="background:white; border:none; color:var(--chocolate); padding:8px 16px; border-radius:20px; cursor:pointer; font-size:0.85rem; font-weight:bold">Cancelar</button>
</div>

<div style="position:fixed; bottom:10px; right:10px; opacity:0.3; font-size:0.7rem; pointer-events:none" id="user-badge"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- State & Config ---
    let app, auth, db, appId;
    let isOffline = false;
    let mapInstance = null; 
    let polyline = null; 
    let watchId = null;

    const BIBLE_BOOKS = [
        "Gênesis", "Êxodo", "Levítico", "Números", "Deuteronômio", "Josué", "Juízes", "Rute", "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", "1 Crônicas", "2 Crônicas", "Esdras", "Neemias", "Ester", "Jó", "Salmos", "Provérbios", "Eclesiastes", "Cânticos", "Isaías", "Jeremias", "Lamentações", "Ezequiel", "Daniel", "Oseias", "Joel", "Amós", "Obadias", "Jonas", "Miqueias", "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias", "Mateus", "Marcos", "Lucas", "João", "Atos", "Romanos", "1 Coríntios", "2 Coríntios", "Gálatas", "Efésios", "Filipenses", "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", "1 Timóteo", "2 Timóteo", "Tito", "Filemom", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", "1 João", "2 João", "3 João", "Judas", "Apocalipse"
    ];

    const VERSES_POOL = [
        { t: "O Senhor é o meu pastor, nada me faltará.", r: "Salmos 23:1", e: "Confie na provisão e cuidado de Deus em todas as áreas da sua vida." },
        { t: "Tudo posso naquele que me fortalece.", r: "Filipenses 4:13", e: "Sua força não vem de você mesmo, mas da conexão constante com o divino." }
    ];

    let state = {
        user: null,
        path: ['root'],
        items: [],
        selectedMonth: new Date().getMonth(),
        selectedYear: new Date().getFullYear(),
        bible: { book: 'Gênesis', chapter: 1, text: '', loading: false, fullData: null },
        health: { walking: false, distance: 0, path: [], startTime: null, duration: 0 },
        weightExpanded: false,
        menstrualView: null,
        itemToDelete: null,
        selectionMode: false,
        selectedIds: [],
        editingId: null,
        editingHistoryIndex: null,
        gpsSettings: { defaultCity: {lat: -23.5505, lng: -46.6333}, cityName: "São Paulo - SP", state: "SP" },
        shareItemId: null
    };
    
    // --- Setup ---
    try {
        if(typeof __firebase_config !== 'undefined' && __firebase_config) {
            const firebaseConfig = JSON.parse(__firebase_config);
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'cm-premium-v1';
        } else { throw new Error("Offline Mode"); }
    } catch(e) {
        console.warn("Starting Offline Mode");
        isOffline = true;
    }

    // --- Toast System ---
    window.showToast = (msg, type = 'success') => {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" style="width:20px"></i><span>${msg}</span>`;
        container.appendChild(el);
        if(window.lucide) window.lucide.createIcons();
        setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(-20px)'; setTimeout(() => el.remove(), 300); }, 3000);
    };

    // --- Data Handlers ---
    const _addDoc = async (coll, data) => {
        if(isOffline) {
            const newItem = { id: 'loc_' + Date.now() + Math.random().toString(36).substr(2,9), ...data };
            state.items.push(newItem);
            saveLocal(); render(); return;
        }
        await addDoc(coll, data);
    };

    const _updateDoc = async (ref, data) => {
        if(isOffline) {
            const idx = state.items.findIndex(i => i.id === ref.id);
            if(idx > -1) {
                const merge = (target, source) => {
                    for (const key in source) {
                        if (source[key] instanceof Object && key in target) {
                            Object.assign(source[key], merge(target[key], source[key]));
                        }
                    }
                    Object.assign(target || {}, source);
                    return target;
                };
                Object.keys(data).forEach(key => {
                    if (key.includes('.')) {
                        const [root, child] = key.split('.');
                        if (!state.items[idx][root]) state.items[idx][root] = {};
                        state.items[idx][root][child] = data[key];
                    } else {
                        state.items[idx][key] = data[key];
                    }
                });
                saveLocal(); render();
            }
            return;
        }
        await updateDoc(ref, data);
    };

    const _deleteDoc = async (ref) => {
        if(isOffline) {
            state.items = state.items.filter(i => i.id !== ref.id);
            saveLocal(); render(); return;
        }
        await deleteDoc(ref);
    };

    const saveLocal = () => localStorage.setItem('cm_premium_data', JSON.stringify(state.items));

    // --- Initialization ---
    const initApp = async () => {
        setInterval(() => {
            const now = new Date();
            const el = document.getElementById('clock-display');
            if(el) el.innerText = now.toLocaleDateString('pt-PT', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
        }, 1000);

        if(isOffline) {
            state.user = { uid: 'offline_user', isAnonymous: true };
            const stored = localStorage.getItem('cm_premium_data');
            if(stored) state.items = JSON.parse(stored);
            ensureBaseFolders();
            const settings = state.items.find(i => i.type === 'gps_settings');
            if(settings) state.gpsSettings = settings.content;
            document.getElementById('loading-screen').style.display = 'none';
            render();
        } else {
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user) {
                    document.getElementById('user-badge').innerText = user.uid.substring(0,8);
                    setupDataListener();
                }
            });
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }
    };

    const setupDataListener = () => {
        const itemsCol = collection(db, 'artifacts', appId, 'users', state.user.uid, 'items');
        onSnapshot(itemsCol, (snap) => {
            state.items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            const settings = state.items.find(i => i.type === 'gps_settings');
            if(settings) state.gpsSettings = settings.content;
            document.getElementById('loading-screen').style.display = 'none';
            ensureBaseFolders();
            render();
        }, (err) => {
            console.error(err);
            window.showToast("Erro de conexão. Mudando para Offline.", "error");
            isOffline = true;
            initApp();
        });
    };

    const ensureBaseFolders = async () => {
        const folders = [
            { id: 'f_pendencias', name: 'Pendências', parentId: 'financeiro', type: 'folder' },
            { id: 'f_despesas', name: 'Despesas', parentId: 'financeiro', type: 'folder' },
            { id: 'f_investimentos', name: 'Investimentos', parentId: 'financeiro', type: 'folder' },
            { id: 'saude', name: 'Saúde', type: 'root_area' },
            { id: 'financeiro', name: 'Financeiro', type: 'root_area' }
        ];
        if (isOffline) {
            folders.forEach(f => {
                if(!state.items.find(i => i.id === f.id)) state.items.push(f);
            });
        } else {
            try {
                for (const f of folders) {
                    if (!state.items.find(i => i.id === f.id)) {
                        await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', f.id), {
                            ...f, createdAt: Date.now()
                        });
                    }
                }
            } catch(e) { console.error("Error creating base folders", e); }
        }
    };
    
    // --- Navigation & Routing ---
    const ROOT_AREAS = [
        { id: 'pessoal', name: 'Pessoal', icon: 'user' },
        { id: 'profissional', name: 'Profissional', icon: 'briefcase' },
        { id: 'financeiro', name: 'Financeiro', icon: 'trending-up' },
        { id: 'lifestyle', name: 'Lifestyle', icon: 'sparkles' },
        { id: 'saude', name: 'Saúde', icon: 'heart' },
        { id: 'planejamento', name: 'Planejamento', icon: 'calendar' },
        { id: 'biblia', name: 'Bíblia', icon: 'book-open' }
    ];

    window.navigate = async (id) => { 
        if(state.selectionMode) return;
        state.path.push(id); render(); 
    };
    
    window.goBack = (idx) => { 
        if(state.selectionMode) window.toggleSelectionMode();
        if(idx === undefined) state.path.pop();
        else state.path = state.path.slice(0, idx + 1); 
        render(); 
    };

    // --- Render Logic ---
    window.render = () => {
        const main = document.getElementById('main-content');
        const bread = document.getElementById('breadcrumb-container');
        const currentId = state.path[state.path.length - 1];
        
        bread.innerHTML = state.path.map((id, i) => {
            const name = id === 'root' ? 'Início' : (ROOT_AREAS.find(a=>a.id===id)?.name || state.items.find(it=>it.id===id)?.name || id);
            return `<span class="breadcrumb-item" onclick="goBack(${i})">${i===0 ? '<i data-lucide="home" style="width:14px"></i>' : ''} ${name}</span>`;
        }).join('<i data-lucide="chevron-right" style="width:14px; opacity:0.3"></i>');

        main.innerHTML = '';
        
        const folder = state.items.find(i => i.id === currentId) || ROOT_AREAS.find(a => a.id === currentId);
        
        if (currentId === 'root') renderDashboard(main);
        else if (currentId === 'financeiro') renderFinanceRoot(main); 
        else if (currentId === 'biblia') renderBible(main);
        else if (currentId === 'saude') renderHealth(main);
        else if (folder?.name === 'Investimentos') renderPiggies(main, currentId);
        else if (folder?.name === 'Despesas') renderFinance(main, currentId, 'expense', 'Despesas');
        else if (folder?.name === 'Pendências') renderFinance(main, currentId, 'pendency', 'Pendências');
        else {
            const item = state.items.find(i => i.id === currentId);
            if(item && item.type !== 'folder' && item.type !== 'custom_area') renderToolItem(main, item);
            else renderGeneralFolder(main, currentId);
        }
        if(window.lucide) window.lucide.createIcons();
    };

    const renderDashboard = (el) => {
        const verse = VERSES_POOL[(new Date().getDate() + new Date().getMonth() * 31) % VERSES_POOL.length];
        const fab = `
            <div class="floating-star-btn" onclick="window.toggleCreateMenu(this)">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                    <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" />
                    <path d="M18 2L19 5L22 6L19 7L18 10L17 7L14 6L17 5L18 2Z" transform="scale(0.5) translate(20, -10)" />
                </svg>
            </div>
            <div class="create-menu-dropdown" style="bottom: 100px; right: 30px; top: auto;">
                <div class="create-menu-item" onclick="window.openModal('create_area')"><i data-lucide="layout-grid"></i> Criar Nova Área</div>
            </div>
        `;

        el.innerHTML = `
            <div class="verse-card">
                <div class="verse-text">"${verse.t}"</div>
                <div class="verse-ref">${verse.r}</div>
            </div>
            <div class="section-header"><h2>Minhas Áreas</h2></div><div class="grid-container"></div>
            ${fab}
        `;
        
        const grid = el.querySelector('.grid-container');
        ROOT_AREAS.forEach(a => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<i data-lucide="${a.icon}" style="color:var(--gold); width:28px; height:28px;"></i><b style="font-size:1.1rem; color:var(--chocolate)">${a.name}</b>`;
            card.onclick = () => window.navigate(a.id);
            grid.appendChild(card);
        });

        const customAreas = state.items.filter(i => i.type === 'custom_area' && i.parentId === 'root');
        customAreas.forEach(a => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.position = 'relative';
            card.innerHTML = `
                <i data-lucide="layout" style="color:var(--gold); width:28px; height:28px;"></i>
                <b style="font-size:1.1rem; color:var(--chocolate); flex:1">${a.name}</b>
                ${renderActionMenu(a.id, a.type, a.name)}
            `;
            card.onclick = (e) => {
                if(e.target.closest('.create-menu-container')) return;
                window.navigate(a.id);
            };
            grid.appendChild(card);
        });
    };

    // --- Bible Module (Robust Offline/Online Hybrid) ---
    const renderBible = async (el) => {
        el.innerHTML = `
            <div class="section-header">
                <h2>Bíblia (NVI/Almeida)</h2>
                <div style="display:flex; gap:10px">
                    <select id="bible-book" class="form-control" style="width:140px; padding:8px" onchange="window.updateBibleNav()"></select>
                    <input type="number" id="bible-chapter" class="form-control" style="width:70px; padding:8px" min="1" value="${state.bible.chapter}" onchange="window.updateBibleNav()">
                    <button class="btn-add" onclick="window.fetchBibleText()">Ler</button>
                </div>
            </div>
            <div id="bible-content" style="background:white; padding:30px; border-radius:24px; box-shadow:var(--shadow); min-height:400px; line-height:1.8; color:#444">
                ${state.bible.loading ? '<div style="text-align:center; padding:50px; opacity:0.6">Baixando Bíblia Completa... (apenas na 1ª vez)</div>' : (state.bible.text || '<div style="text-align:center; padding:50px; opacity:0.6">Selecione um livro e capítulo para começar a leitura.</div>')}
            </div>
        `;
        
        const sel = document.getElementById('bible-book');
        BIBLE_BOOKS.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            if(b === state.bible.book) opt.selected = true;
            sel.appendChild(opt);
        });
    };

    window.updateBibleNav = () => {
        state.bible.book = document.getElementById('bible-book').value;
        state.bible.chapter = document.getElementById('bible-chapter').value;
    };

    // Helper to map English/Standardized JSON names to Portuguese display names if needed
    // Assuming the JSON source uses standard Portuguese names or close enough matching
    
    window.fetchBibleText = async () => {
        state.bible.loading = true;
        render();
        try {
            // Load Full Bible Data if not present (One-time fetch for session)
            if (!state.bible.fullData) {
                // Fetching Almeida version as robust open source fallback that acts like NVI in structure
                // Using a reliable Github Raw source that allows CORS
                const res = await fetch('https://raw.githubusercontent.com/thiagobodruk/bible/master/json/pt_aa.json');
                if(!res.ok) throw new Error("Erro ao baixar base de dados.");
                state.bible.fullData = await res.json();
                window.showToast("Bíblia carregada com sucesso!");
            }

            // Find Book
            // The JSON structure is usually [ { "abbrev": "gn", "name": "Gênesis", "chapters": [...] }, ... ]
            // We need to match the name selected in dropdown to the name in JSON
            const bookData = state.bible.fullData.find(b => b.name === state.bible.book || b.name.includes(state.bible.book));
            
            if (bookData) {
                const chapterIndex = parseInt(state.bible.chapter) - 1;
                if (chapterIndex >= 0 && chapterIndex < bookData.chapters.length) {
                    const verses = bookData.chapters[chapterIndex];
                    let html = `<h3 style="text-align:center; margin-bottom:20px; color:var(--chocolate)">${bookData.name} ${state.bible.chapter}</h3>`;
                    html += verses.map((v, i) => `<p style="margin-bottom:10px; line-height:1.6"><sup style="color:var(--gold); font-weight:bold; margin-right:4px; font-size:0.8rem">${i+1}</sup> ${v}</p>`).join('');
                    state.bible.text = html;
                } else {
                    state.bible.text = `<div style="text-align:center; padding:20px; color:var(--danger)">Capítulo inexistente. Este livro tem ${bookData.chapters.length} capítulos.</div>`;
                }
            } else {
                state.bible.text = `<div style="text-align:center; padding:20px; color:var(--danger)">Livro não encontrado na base de dados.</div>`;
            }

        } catch(e) {
            console.error(e);
            state.bible.text = `<div style="color:var(--danger); text-align:center; padding:20px">
                Erro ao carregar a Bíblia.<br><br>
                <small>Detalhe: ${e.message}</small><br>
                Verifique sua conexão com a internet para o primeiro download.
            </div>`;
        }
        state.bible.loading = false;
        render();
    };

    // --- Health Module ---
    const calculateHealthStats = (weightItem) => {
        if(!weightItem) return null;
        const { current, target, startDate, periodMonths, history, startWeight } = weightItem.content;
        const monthsPassed = Math.max(0, (new Date().getFullYear() - new Date(startDate).getFullYear()) * 12 + (new Date().getMonth() - new Date(startDate).getMonth()));
        const monthsRemaining = Math.max(1, periodMonths - monthsPassed);
        const weightToLose = parseFloat(current) - parseFloat(target);
        const totalLossRequired = parseFloat(startWeight) - parseFloat(target);
        const mma = weightToLose > 0 ? (weightToLose / monthsRemaining).toFixed(2) : 0;
        const sortedHistory = [...history].sort((a,b) => new Date(b.date) - new Date(a.date));
        const startMonthWeight = sortedHistory.length > 0 ? sortedHistory[0].weight : current;
        const progress = totalLossRequired > 0 ? ((parseFloat(startWeight) - parseFloat(current)) / totalLossRequired * 100) : 0;
        
        return { current, target, startWeight, mma, progress: Math.min(100, Math.max(0, progress)), monthsRemaining, totalLossRequired, periodMonths, startDate, history: sortedHistory };
    };

    const renderHealth = (el) => {
        const weightItem = state.items.find(i => i.type === 'health_weight');
        const stats = calculateHealthStats(weightItem);
        const meds = state.items.filter(i => i.type === 'health_med');
        const diet = state.items.find(i => i.type === 'health_food');

        el.innerHTML = `
            <div class="section-header"><h2>Saúde e Bem-estar</h2>${renderCreateButton()}</div>
            
            <div class="grid-container">
            <!-- Menstrual Card (Now Smaller/Grid Item) -->
            <div class="card" style="display:block; padding:15px">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                    <div style="display:flex; align-items:center; gap:8px">
                        <div style="width:32px; height:32px; background:#FFEBEE; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--danger)"><i data-lucide="calendar-heart" style="width:16px"></i></div>
                        <div style="font-weight:700; color:var(--chocolate); font-size:0.9rem">Ciclo</div>
                    </div>
                    <button class="btn-cancel" style="padding:4px 8px" onclick="window.openModal('menstrual_settings')"><i data-lucide="settings" style="width:12px"></i></button>
                </div>
                ${renderCalendar()}
            </div>

            <!-- GPS Card (Now Smaller/Grid Item) -->
            <div class="card" style="display:block; padding:15px">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                    <div style="display:flex; align-items:center; gap:8px">
                         <div style="width:32px; height:32px; background:#E3F2FD; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#1565C0"><i data-lucide="map-pin" style="width:16px"></i></div>
                         <div style="font-weight:700; color:var(--chocolate); font-size:0.9rem">GPS</div>
                    </div>
                    <button class="btn-cancel" style="padding:4px 8px" onclick="window.openModal('gps_settings')"><i data-lucide="settings" style="width:12px"></i></button>
                </div>
                <div class="gps-map-container"><div id="gps-map"></div></div>
                <div class="gps-overlay-stats" style="padding:10px 0">
                    <div><div class="gps-stat-value" id="gps-dist" style="font-size:1.2rem">0.00</div><div style="font-size:0.6rem; color:#888; font-weight:600">KM</div></div>
                    <div><div class="gps-stat-value" id="gps-time" style="font-size:1.2rem">00:00</div><div style="font-size:0.6rem; color:#888; font-weight:600">TEMPO</div></div>
                </div>
                <button class="btn-add" id="gps-toggle-btn" style="width:100%; justify-content:center; font-size:0.8rem; padding:8px" onclick="window.toggleGpsTracking()"><i data-lucide="play" style="width:14px"></i> Iniciar</button>
            </div>
            </div>

            <!-- Weight Card -->
            <div class="card" style="display:block; margin:20px 0">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <div style="display:flex; align-items:center; gap:10px">
                        <div style="width:40px; height:40px; background:#FFF3E0; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--chocolate)"><i data-lucide="scale"></i></div>
                        <div>
                            <div style="font-weight:700; color:var(--chocolate)">Controle de Peso</div>
                            <div style="font-size:0.8rem; color:#888">${stats ? `Meta: ${stats.target}kg` : 'Configure sua meta'}</div>
                        </div>
                    </div>
                    ${stats ? `<button class="btn-add" style="padding:5px 15px; font-size:0.7rem" onclick="window.openModal('health_weight_register')">Pesar</button>` : `<button class="btn-add" onclick="window.openModal('health_weight_config')">Configurar</button>`}
                </div>
                ${stats ? `
                    <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; text-align:center">
                        <div><div style="font-size:1.5rem; font-weight:800; color:var(--chocolate)">${stats.current}</div><div style="font-size:0.7rem; text-transform:uppercase; color:#999; font-weight:600">Atual (kg)</div></div>
                        <div><div style="font-size:1.5rem; font-weight:800; color:${stats.mma > 0 ? 'var(--chocolate)' : 'var(--success)'}">${stats.mma}</div><div style="font-size:0.7rem; text-transform:uppercase; color:#999; font-weight:600">Meta/Mês</div></div>
                        <div><div style="font-size:1.5rem; font-weight:800; color:var(--gold)">${stats.monthsRemaining}</div><div style="font-size:0.7rem; text-transform:uppercase; color:#999; font-weight:600">Meses Rest.</div></div>
                    </div>
                    <div class="weight-progress-bar"><div class="weight-progress-fill" style="width:${stats.progress}%"></div></div>
                    <div style="text-align:right; font-size:0.7rem; color:#888; margin-top:4px">${stats.progress.toFixed(0)}% da meta total</div>
                    <div style="margin-top:15px; text-align:center; cursor:pointer; color:var(--gold); font-size:0.8rem; font-weight:600" onclick="window.openWeightHistory()">Ver Histórico Completo</div>
                ` : ''}
            </div>

            <!-- Meds & Diet -->
            <div class="grid-container">
                <div class="card" style="display:block">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px"><b>Medicamentos</b><button class="btn-add" style="padding:4px 8px" onclick="window.openModal('health_med')">+</button></div>
                    ${meds.length ? meds.map(m => `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center"><div><b>${m.name}</b><br><small>${m.content.time} - ${m.content.instructions}</small></div><i data-lucide="trash-2" style="width:14px; cursor:pointer; color:#999" onclick="window.openDeleteModal('${m.id}','${m.name}')"></i></div>`).join('') : '<div style="opacity:0.5; font-size:0.8rem">Nenhum medicamento.</div>'}
                </div>
                <div class="card" style="display:block">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px"><b>Dieta</b><button class="btn-add" style="padding:4px 8px" onclick="window.openModal('health_food')"><i data-lucide="edit-2" style="width:14px"></i></button></div>
                    <div style="white-space:pre-wrap; font-size:0.85rem; color:#555; max-height:150px; overflow-y:auto">${diet ? diet.content.text : 'Nenhuma dieta cadastrada.'}</div>
                </div>
            </div>
        `;

        setTimeout(() => {
            if(!mapInstance) {
                mapInstance = L.map('gps-map').setView([state.gpsSettings.defaultCity.lat, state.gpsSettings.defaultCity.lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
            }
        }, 500);
    };

    const renderCalendar = () => {
        const today = new Date();
        const viewDate = state.menstrualView || today;
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay();

        // Profile Data
        const profile = state.items.find(i => i.type === 'menstrual_profile');
        const logs = state.items.filter(i => i.type === 'menstrual_cycle');
        
        const flowDuration = profile && profile.content.flowDuration ? parseInt(profile.content.flowDuration) : 5;
        const cycleDuration = profile && profile.content.cycleDuration ? parseInt(profile.content.cycleDuration) : 28;
        
        let flowDays = new Set();
        let fertileDays = new Set();
        
        // Calculate days from logs
        logs.forEach(l => {
            const startDate = new Date(l.content.date);
            // Mark flow duration
            for(let i=0; i<flowDuration; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                flowDays.add(d.toISOString().split('T')[0]);
            }
            // Mark fertile window (approx 14 days before NEXT period)
            // Next period approx = startDate + cycleDuration
            const nextPeriod = new Date(startDate);
            nextPeriod.setDate(startDate.getDate() + cycleDuration);
            const ovulation = new Date(nextPeriod);
            ovulation.setDate(nextPeriod.getDate() - 14);
            
            // Mark 5 fertile days around ovulation
            for(let k=-2; k<=2; k++) {
                const f = new Date(ovulation);
                f.setDate(ovulation.getDate() + k);
                fertileDays.add(f.toISOString().split('T')[0]);
            }
        });

        // Predictions from Last Contraceptive/Log Date if set
        if (profile && profile.content.lastContraDate) {
            const last = new Date(profile.content.lastContraDate);
            for(let k=0; k<12; k++) { // Predict next 12 cycles
                const next = new Date(last);
                next.setDate(last.getDate() + (cycleDuration * (k+1)));
                
                // Add predicted flow
                for(let i=0; i<flowDuration; i++) {
                    const d = new Date(next);
                    d.setDate(next.getDate() + i);
                    flowDays.add(d.toISOString().split('T')[0]);
                }
                
                // Add predicted fertile
                const nextNextPeriod = new Date(next);
                nextNextPeriod.setDate(next.getDate() + cycleDuration);
                const ovulation = new Date(nextNextPeriod);
                ovulation.setDate(nextNextPeriod.getDate() - 14);
                for(let j=-2; j<=2; j++) {
                    const f = new Date(ovulation);
                    f.setDate(ovulation.getDate() + j);
                    fertileDays.add(f.toISOString().split('T')[0]);
                }
            }
        }

        let html = `
            <div style="display:flex; justify-content:center; align-items:center; gap:15px; margin-bottom:10px">
                <button class="nav-btn" onclick="window.changeCalMonth(-1)" style="width:24px; height:24px"><i data-lucide="chevron-left" style="width:14px"></i></button>
                <span style="font-weight:700; color:var(--chocolate); font-size:0.85rem">${viewDate.toLocaleDateString('pt-BR',{month:'long', year:'numeric'})}</span>
                <button class="nav-btn" onclick="window.changeCalMonth(1)" style="width:24px; height:24px"><i data-lucide="chevron-right" style="width:14px"></i></button>
            </div>
            <div class="cal-header"><div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div></div>
            <div class="cal-grid">
        `;

        // Empty slots
        for(let i=0; i<firstDay; i++) html += `<div></div>`;

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            const log = logs.find(l => l.content.date === dateStr);
            
            const isFlow = flowDays.has(dateStr);
            const isFertile = fertileDays.has(dateStr);

            html += `
                <div class="cal-day ${isToday ? 'today' : ''} ${isFlow ? 'period-active' : ''}" onclick="window.openModal('menstrual_log', '${dateStr}')">
                    ${d}
                    <div class="cal-line"></div>
                    ${log && log.content.sex ? `<i data-lucide="heart" class="cal-heart" fill="${log.content.protection ? 'var(--heart-safe)' : 'var(--heart-unsafe)'}" stroke="none"></i>` : ''}
                    ${isFertile ? `<div class="cal-star"></div>` : ''}
                </div>
            `;
        }
        html += `</div>`;
        html += `<div style="display:flex; gap:15px; justify-content:center; margin-top:10px; font-size:0.65rem; color:#888">
            <div style="display:flex; align-items:center; gap:4px"><div style="width:8px; height:8px; background:var(--gold); clip-path: polygon(50% 0%, 61% 35%, 100% 50%, 61% 65%, 50% 100%, 39% 65%, 0% 50%, 39% 35%);"></div> Fértil</div>
            <div style="display:flex; align-items:center; gap:4px"><div style="width:16px; height:3px; background:var(--period-line); border-radius:2px"></div> Fluxo</div>
        </div>`;
        return html;
    };

    // --- GPS Logic ---
    window.toggleGpsTracking = () => {
        const btn = document.getElementById('gps-toggle-btn');
        if(!state.health.walking) {
            // Start
            state.health.walking = true;
            state.health.startTime = Date.now();
            state.health.path = [];
            state.health.distance = 0;
            btn.innerHTML = `<i data-lucide="square"></i> Parar`;
            btn.style.background = 'var(--danger)';
            
            if(navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition((pos) => {
                    const { latitude, longitude } = pos.coords;
                    const latLng = [latitude, longitude];
                    state.health.path.push(latLng);
                    
                    if(state.health.path.length > 1) {
                        const last = state.health.path[state.health.path.length-2];
                        const dist = mapInstance.distance(last, latLng); // Leaflet distance in meters
                        state.health.distance += dist;
                    }

                    // Update Map
                    if(!polyline) {
                        polyline = L.polyline(state.health.path, {color: 'var(--chocolate)'}).addTo(mapInstance);
                    } else {
                        polyline.setLatLngs(state.health.path);
                    }
                    mapInstance.setView(latLng);

                    // Update UI
                    document.getElementById('gps-dist').innerText = (state.health.distance / 1000).toFixed(2);
                }, (err) => alert("Erro GPS: " + err.message), { enableHighAccuracy: true });
            }
            
            // Timer
            state.health.timer = setInterval(() => {
                const diff = Math.floor((Date.now() - state.health.startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2,'0');
                const s = (diff % 60).toString().padStart(2,'0');
                document.getElementById('gps-time').innerText = `${m}:${s}`;
            }, 1000);

        } else {
            // Stop
            navigator.geolocation.clearWatch(watchId);
            clearInterval(state.health.timer);
            state.health.walking = false;
            btn.innerHTML = `<i data-lucide="play"></i> Iniciar`;
            btn.style.background = 'var(--chocolate)';
            
            if(confirm("Salvar atividade?")) {
                _addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'items'), {
                    parentId: 'saude',
                    type: 'gps_session',
                    name: 'Caminhada',
                    createdAt: Date.now(),
                    content: { date: new Date().toISOString(), distance: state.health.distance, duration: Date.now() - state.health.startTime }
                });
            }
            
            // Reset UI
            if(polyline) polyline.remove();
            polyline = null;
            document.getElementById('gps-dist').innerText = "0.00";
            document.getElementById('gps-time').innerText = "00:00";
        }
    };

    // --- Action Functions ---
    window.renameItem = (id, name) => { window.openModal('rename', id); };
    window.replaceItem = (id, type) => { window.openModal(type, id); };
    window.moveItem = async (id) => {
        const newParent = prompt("Digite o ID da pasta de destino:");
        if(newParent) {
             const ref = isOffline ? {id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', id);
             await _updateDoc(ref, { parentId: newParent });
             window.showToast("Item movido.");
             render();
        }
    };
    
    // Deletion Logic
    window.openDeleteModal = (id, name) => {
        state.itemToDelete = id;
        document.getElementById('delete-modal-text').innerText = `Tem certeza que deseja apagar "${name}"?`;
        const m = document.getElementById('delete-modal-overlay');
        m.style.display = 'flex'; setTimeout(() => m.classList.add('open'), 10);
    };
    window.closeDeleteModal = () => {
        const m = document.getElementById('delete-modal-overlay');
        m.classList.remove('open'); setTimeout(() => m.style.display = 'none', 300);
        state.itemToDelete = null;
    };
    window.confirmDelete = async () => {
        if(state.itemToDelete) {
            await _deleteDoc(isOffline ? {id: state.itemToDelete} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', state.itemToDelete));
            window.closeDeleteModal();
            window.showToast("Item excluído.");
        }
    };

    // Selection Logic
    window.toggleSelectionMode = () => {
        state.selectionMode = !state.selectionMode;
        state.selectedIds = [];
        const bar = document.getElementById('batch-actions-bar');
        bar.style.transform = state.selectionMode ? "translate(-50%, 0)" : "translate(-50%, 150px)";
        render();
    };
    window.toggleSelectItem = (id) => {
        if(state.selectedIds.includes(id)) state.selectedIds = state.selectedIds.filter(i => i !== id);
        else state.selectedIds.push(id);
        document.getElementById('selected-count').innerText = `${state.selectedIds.length} selecionados`;
        render();
    };
    window.confirmBatchDelete = async () => {
        if(confirm(`Excluir ${state.selectedIds.length} itens?`)) {
            for(const id of state.selectedIds) {
                await _deleteDoc(isOffline ? {id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', id));
            }
            window.toggleSelectionMode();
            window.showToast("Itens excluídos.");
        }
    };

    // Checklist Logic
    window.addCLItem = async (id) => {
        const item = state.items.find(i => i.id === id);
        const newItems = [...(item.content.items || []), { text: '', checked: false, val: 0 }];
        await _updateDoc(isOffline ? {id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', id), { 'content.items': newItems });
    };
    window.toggleCLItem = async (id, idx) => {
        const item = state.items.find(i => i.id === id);
        const newItems = [...item.content.items];
        newItems[idx].checked = !newItems[idx].checked;
        await _updateDoc(isOffline ? {id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', id), { 'content.items': newItems });
    };
    window.deleteCLItem = async (id, idx) => {
        const item = state.items.find(i => i.id === id);
        const newItems = item.content.items.filter((_, i) => i !== idx);
        await _updateDoc(isOffline ? {id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', id), { 'content.items': newItems });
    };
    window.updateCL = async (id, idx, field, val) => {
        const item = state.items.find(i => i.id === id);
        const newItems = [...item.content.items];
        newItems[idx][field] = val;
        await _updateDoc(isOffline ? {id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', id), { 'content.items': newItems });
    };

    // Finance Logic
    window.togglePaid = async (id) => {
        const item = state.items.find(i => i.id === id);
        await _updateDoc(isOffline ? {id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', id), { 'content.paid': !item.content.paid });
    };
    window.makeDeposit = async (id) => {
        const val = parseFloat(document.getElementById(`dep-${id}`).value);
        if(!val) return;
        const item = state.items.find(i => i.id === id);
        await _updateDoc(isOffline ? {id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', id), { 'content.saved': (parseFloat(item.content.saved)||0) + val });
    };
    
    // Copy Utils
    window.copyBankData = (bank, holder, ag, cc, pix) => {
        const text = `Banco: ${bank}\nTitular: ${holder}\nAg: ${ag}\nCC: ${cc}\nPIX: ${pix}`;
        window.copyToClipboard(text);
    };
    window.copyToClipboard = (text) => {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        window.showToast("Copiado!");
    };
    
    // Sharing
    window.shareItem = (id) => {
        state.shareItemId = id;
        const link = `https://organizer-premium.app/share/${id}`;
        if (navigator.share) {
            navigator.share({ title: 'Organizer Premium', text: 'Confira este item:', url: link }).catch(console.error);
        } else {
            document.getElementById('share-link-display').innerText = link;
            const m = document.getElementById('share-modal');
            m.style.display = 'flex'; setTimeout(()=>m.classList.add('open'), 10);
        }
    };
    window.shareDirectly = () => { window.open(`whatsapp://send?text=${encodeURIComponent(document.getElementById('share-link-display').innerText)}`); };
    window.copyShareLink = () => { window.copyToClipboard(document.getElementById('share-link-display').innerText); };
    window.downloadItem = (id) => {
        const item = state.items.find(i => i.id === id);
        if(!item) return;
        if (item.type === 'file') {
            const link = document.createElement("a"); link.href = item.content.data; link.download = item.name;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        } else {
            const text = JSON.stringify(item.content, null, 2);
            const blob = new Blob([text], {type: 'text/plain'});
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `${item.name}.txt`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
    };
    window.editItem = (id, type) => {
        if(type === 'health_weight') return window.openModal('health_weight_config', id);
        window.openModal(type, id);
    };

    // --- Finance Renderers ---
    const renderFinanceRoot = (el) => {
        const subfolders = [
            state.items.find(i => i.id === 'f_despesas') || {id:'f_despesas', name:'Despesas', type:'folder'},
            state.items.find(i => i.id === 'f_pendencias') || {id:'f_pendencias', name:'Pendências', type:'folder'},
            state.items.find(i => i.id === 'f_investimentos') || {id:'f_investimentos', name:'Investimentos', type:'folder'}
        ];
        el.innerHTML = `<div class="section-header"><h2>Financeiro</h2></div><div class="grid-container">${subfolders.map(f => `<div class="card" onclick="window.navigate('${f.id}')"><i data-lucide="${f.name==='Investimentos'?'trending-up':'dollar-sign'}" style="color:var(--gold)"></i><span style="flex:1; font-weight:600; color:var(--chocolate)">${f.name}</span><i data-lucide="chevron-right" style="opacity:0.3"></i></div>`).join('')}</div>`;
    };

    window.changeMonth = (delta) => {
        state.selectedMonth += delta;
        if(state.selectedMonth > 11) { state.selectedMonth = 0; state.selectedYear++; }
        if(state.selectedMonth < 0) { state.selectedMonth = 11; state.selectedYear--; }
        render();
    };

    const renderFinance = (el, pid, type, title) => {
        const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const list = state.items.filter(i => i.parentId === pid);
        const monthly = list.filter(i => {
            if (!i.content.due) return false;
            const [y, m, d] = i.content.due.split('-').map(Number);
            return (m - 1) === state.selectedMonth && y === state.selectedYear;
        }).sort((a,b) => a.content.due.localeCompare(b.content.due));
        
        const totalPendingGlobal = list.reduce((a,b) => b.content.paid ? a : a + parseFloat(b.content.value), 0);
        const totalMonthPending = monthly.reduce((a,b) => b.content.paid ? a : a + parseFloat(b.content.value), 0);

        el.innerHTML = `
            <div class="section-header"><h2>${title}</h2> ${renderCreateButton()}</div>
            <div class="time-navigator">
                <button class="nav-btn" onclick="window.changeMonth(-1)"><i data-lucide="chevron-left"></i></button>
                <span class="current-date-label">${months[state.selectedMonth]} ${state.selectedYear}</span>
                <button class="nav-btn" onclick="window.changeMonth(1)"><i data-lucide="chevron-right"></i></button>
            </div>
            <div class="summary-card">
                <div class="summary-item"><span>Total Pendente (Global)</span><b>${totalPendingGlobal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</b></div>
                <div class="summary-item"><span>Neste Mês</span><b>${totalMonthPending.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</b></div>
            </div>
            <div class="finance-list">
                ${monthly.length ? monthly.map(i => `<div class="finance-item ${i.content.paid?'paid':''}"><div class="btn-check ${i.content.paid?'active':''}" onclick="window.togglePaid('${i.id}')"><i data-lucide="check" style="width:16px"></i></div><div class="item-text" style="font-weight:600; color:var(--chocolate)">${i.name}</div><div class="amount" style="font-weight:bold; color:${type==='expense'?'var(--danger)':'var(--success)'}">${parseFloat(i.content.value).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div>${renderActionMenu(i.id, i.type, i.name)}</div>`).join('') : '<div style="padding:30px; text-align:center; opacity:0.5">Sem registros para este período.</div>'}
            </div>
            <button class="btn-add" onclick="window.openModal('${type}')" style="margin-top:20px; width:100%; justify-content:center; background:var(--chocolate)"><i data-lucide="plus"></i> Criar Novo Item</button>
            <div style="margin-top:40px; border-top:1px solid #eee; padding-top:20px">
                <h4 style="margin-bottom:15px; color:var(--chocolate)">Conteúdo Adicional</h4>
                <div class="grid-container" id="finance-extras"></div>
            </div>
        `;
        
        // Render Extras (Notes/Files in Finance Folder)
        const extras = list.filter(i => i.type !== 'expense' && i.type !== 'pendency');
        const extrasContainer = el.querySelector('#finance-extras');
        if(extrasContainer && extras.length) {
            extras.forEach(i => {
                const isSelected = state.selectedIds.includes(i.id);
                const icon = {note:'file-text', file:'paperclip'}[i.type] || 'file';
                let cardHTML = '';
                if(i.type === 'file') {
                      const isImg = i.content.fileType.startsWith('image') || /\.(jpg|jpeg|png|gif|bmp|webp|heic)$/i.test(i.name);
                      cardHTML = `<div class="card ${state.selectionMode?'selection-mode':''} ${isSelected?'selected':''}" onclick="${state.selectionMode ? `window.toggleSelectItem('${i.id}')` : `window.openFilePreview('${i.id}')`}">${isImg ? `<img src="${i.content.data}" style="width:40px; height:40px; object-fit:cover; border-radius:8px; margin-right:10px" onerror="this.style.display='none'">` : `<i data-lucide="${icon}" style="color:#999"></i>`}<div style="flex:1; overflow:hidden"><div style="font-weight:600; color:var(--chocolate); white-space:nowrap; text-overflow:ellipsis; overflow:hidden">${i.name}</div>${i.content.caption ? `<div style="font-size:0.75rem; color:#888; white-space:nowrap; text-overflow:ellipsis; overflow:hidden">${i.content.caption}</div>` : ''}</div>${renderActionMenu(i.id, i.type, i.name)}</div>`;
                } else {
                      cardHTML = `<div class="card" onclick="window.editItem('${i.id}','${i.type}')"><i data-lucide="${icon}"></i><span>${i.name}</span>${renderActionMenu(i.id, i.type, i.name)}</div>`;
                }
                extrasContainer.innerHTML += cardHTML;
            });
        }
    };

    const renderPiggies = (el, pid) => {
        const items = state.items.filter(i => i.parentId === pid);
        el.innerHTML = `
            <div class="section-header"><h2>Investimentos</h2></div>
            <div class="grid-container">
                ${items.map(p => {
                    const saved = parseFloat(p.content.saved || 0);
                    const target = parseFloat(p.content.target || 1);
                    const timeMonths = p.content.months || 0;
                    const pct = target > 0 ? Math.min(100, (saved/target)*100) : 0;
                    return `<div class="piggy-card"><div style="display:flex; justify-content:space-between"><b>${p.name}</b>${renderActionMenu(p.id, 'piggy', p.name)}</div><div style="font-size:0.8rem; color:#999; margin-bottom:5px">Prazo: ${timeMonths} meses</div><div style="font-size:1.8rem; font-weight:bold; color:var(--gold); margin:5px 0">${saved.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} <small style="font-size:0.8rem; color:#999">/ ${target.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</small></div><div class="progress-grid">${Array(20).fill(0).map((_,i) => `<div class="progress-block ${i<(pct/5)?'filled':''}"></div>`).join('')}</div><div style="display:flex; gap:5px; margin-top:15px"><input class="form-control" style="padding:8px" type="number" id="dep-${p.id}" placeholder="Depósito..."><button class="btn-add" onclick="window.makeDeposit('${p.id}')">OK</button></div></div>`;
                }).join('')}
                <div class="card" style="justify-content:center; min-height:200px; border:2px dashed #ddd; background:transparent; cursor:pointer" onclick="window.openModal('piggy')">
                    <div style="text-align:center; color:#999"><i data-lucide="plus" style="width:30px; height:30px"></i><br>Novo Objetivo</div>
                </div>
            </div>
        `;
    };

    const renderActionMenu = (id, type, name) => {
        if(state.selectionMode) return '';
        return `
            <div class="create-menu-container" onclick="event.stopPropagation()">
                <div style="padding:8px; cursor:pointer; opacity:0.6; transition:0.2s" onclick="window.toggleActionMenu('${id}')">
                    <i data-lucide="more-vertical"></i>
                </div>
                <div class="create-menu-dropdown" id="action-menu-${id}">
                    <div class="create-menu-item" onclick="window.editItem('${id}', '${type}')"><i data-lucide="edit-2"></i> Editar</div>
                    <div class="create-menu-item" onclick="window.renameItem('${id}', '${name}')"><i data-lucide="type"></i> Renomear</div>
                    <div class="create-menu-item" onclick="window.moveItem('${id}')"><i data-lucide="folder-input"></i> Mover</div>
                    <div class="create-menu-item" onclick="window.shareItem('${id}')"><i data-lucide="share-2"></i> Compartilhar</div>
                    <div class="create-menu-item" onclick="window.downloadItem('${id}')"><i data-lucide="download"></i> Baixar</div>
                    <div class="create-menu-item" style="color:var(--danger)" onclick="window.openDeleteModal('${id}', '${name.replace(/'/g, "\\'")}')"><i data-lucide="trash-2"></i> Excluir</div>
                </div>
            </div>
        `;
    };

    const renderCreateButton = () => {
        if(state.selectionMode) return '';
        return `
            <div style="display:flex; align-items:center; gap:10px">
                <button class="btn-cancel" style="padding:8px 16px" onclick="window.toggleSelectionMode()">Selecionar</button>
                <div class="create-menu-container">
                    <button class="btn-add" onclick="window.toggleCreateMenu(this)"><i data-lucide="plus"></i> Novo</button>
                    <div class="create-menu-dropdown">
                        <div class="create-menu-item" onclick="window.openModal('folder')"><i data-lucide="folder"></i> Pasta</div>
                        <div class="create-menu-item" onclick="window.openModal('note')"><i data-lucide="file-text"></i> Nota</div>
                        <div class="create-menu-item" onclick="window.openModal('file')"><i data-lucide="paperclip"></i> Anexo</div>
                        <div class="create-menu-item" onclick="window.openModal('checklist')"><i data-lucide="list-checks"></i> Checklist</div>
                        <div class="create-menu-item" onclick="window.openModal('checklist_sum')"><i data-lucide="calculator"></i> Checklist + Soma</div>
                        <div class="create-menu-item" onclick="window.openModal('bank')"><i data-lucide="credit-card"></i> Dados Bancários</div>
                        <div class="create-menu-item" onclick="window.openModal('social')"><i data-lucide="at-sign"></i> Social Login</div>
                    </div>
                </div>
            </div>
        `;
    };

    const renderGeneralFolder = (el, pid) => {
        const items = state.items.filter(i => i.parentId === pid);
        el.innerHTML = `<div class="section-header"><h2 style="font-size:1.5rem">Conteúdo</h2>${renderCreateButton()}</div><div class="grid-container">${items.length ? items.map(i => {
            const isSelected = state.selectedIds.includes(i.id);
            const icon = {folder:'folder', note:'file-text', checklist:'list-checks', checklist_sum:'calculator', bank:'credit-card', social:'at-sign', file:'paperclip'}[i.type] || 'file';
            if (i.type === 'file') {
                const isImg = i.content.fileType.startsWith('image') || /\.(jpg|jpeg|png|gif|bmp|webp|heic)$/i.test(i.name);
                return `<div class="card ${state.selectionMode?'selection-mode':''} ${isSelected?'selected':''}" onclick="${state.selectionMode ? `window.toggleSelectItem('${i.id}')` : `window.openFilePreview('${i.id}')`}">${isImg ? `<img src="${i.content.data}" style="width:40px; height:40px; object-fit:cover; border-radius:8px; margin-right:10px" onerror="this.style.display='none'">` : `<i data-lucide="${icon}" style="color:#999"></i>`}<div style="flex:1; overflow:hidden"><div style="font-weight:600; color:var(--chocolate); white-space:nowrap; text-overflow:ellipsis; overflow:hidden">${i.name}</div>${i.content.caption ? `<div style="font-size:0.75rem; color:#888; white-space:nowrap; text-overflow:ellipsis; overflow:hidden">${i.content.caption}</div>` : ''}</div><i data-lucide="check-circle" class="selection-check"></i>${renderActionMenu(i.id, i.type, i.name)}</div>`;
            }
            return `<div class="card ${state.selectionMode?'selection-mode':''} ${isSelected?'selected':''}" onclick="${state.selectionMode ? `window.toggleSelectItem('${i.id}')` : `window.navigate('${i.id}')`}"><i data-lucide="${icon}" style="color:${i.type==='folder'?'var(--gold)':'#999'}"></i><span style="flex:1; font-weight:600; color:var(--chocolate)">${i.name}</span><i data-lucide="check-circle" class="selection-check"></i>${renderActionMenu(i.id, i.type, i.name)}</div>`;
        }).join('') : '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#aaa">Esta pasta está vazia.</div>'}</div>`;
    };

    window.openFilePreview = (id) => {
        const item = state.items.find(i => i.id === id);
        if (!item || item.type !== 'file') return;
        const overlay = document.getElementById('file-preview-modal');
        const content = document.getElementById('file-preview-content');
        const caption = document.getElementById('preview-caption');
        const downloadBtn = document.getElementById('preview-download-btn');
        const title = document.getElementById('preview-filename');

        title.innerText = item.name;
        caption.innerText = item.content.caption || '';
        downloadBtn.href = item.content.data;
        downloadBtn.download = item.name;

        const isImg = item.content.fileType.startsWith('image') || /\.(jpg|jpeg|png|gif|bmp|webp|heic)$/i.test(item.name);
        if (isImg) { content.innerHTML = `<img src="${item.content.data}" alt="${item.name}">`; } 
        else if (item.content.fileType === 'application/pdf') { content.innerHTML = `<iframe src="${item.content.data}"></iframe>`; } 
        else { content.innerHTML = `<div style="padding:40px; color:#666"><i data-lucide="file" style="width:48px; height:48px; margin-bottom:10px"></i><br>Visualização não disponível.</div>`; }

        overlay.style.display = 'flex'; setTimeout(() => { overlay.classList.add('open'); window.lucide.createIcons(); }, 10);
    }
    window.closePreviewModal = () => { const o = document.getElementById('file-preview-modal'); o.classList.remove('open'); setTimeout(() => o.style.display = 'none', 300); }

    const renderToolItem = (el, item) => {
        let content = '';
        if(item.type === 'note') content = `<div style="white-space:pre-wrap; line-height:1.6; color:#444">${item.content.text}</div>`;
        else if(item.type.includes('checklist')) {
            const isSum = item.type === 'checklist_sum';
            const items = item.content && item.content.items ? item.content.items : [];
            const total = isSum ? items.reduce((a,b)=>b.checked?a+(parseFloat(b.val)||0):a,0) : 0;
            content = `${isSum ? `<div style="text-align:right; font-size:1.5rem; color:var(--success); font-weight:bold; margin-bottom:15px">${total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div>` : ''}<div style="display:flex; flex-direction:column; gap:10px">${items.map((it, idx) => `<div style="display:flex; gap:10px; align-items:center; padding:8px; border-bottom:1px solid #eee"><div class="btn-check ${it.checked?'active':''}" onclick="window.toggleCLItem('${item.id}', ${idx})"><i data-lucide="check" style="width:16px"></i></div><input class="checklist-input form-control" style="border:none; background:transparent; text-decoration:${it.checked?'line-through':''}" value="${it.text}" onchange="window.updateCL('${item.id}',${idx},'text',this.value)">${isSum ? `<input class="form-control" type="number" style="width:80px; text-align:right" value="${it.val}" onchange="window.updateCL('${item.id}',${idx},'val',this.value)">` : ''}<i data-lucide="x" style="width:16px; cursor:pointer; opacity:0.5" onclick="window.deleteCLItem('${item.id}', ${idx})"></i></div>`).join('')}<button class="btn-add" style="align-self:center; margin-top:10px" onclick="window.addCLItem('${item.id}')"><i data-lucide="plus"></i> Item</button></div>`;
        } else if (item.type === 'bank') {
            const data = item.content;
            content = `<div style="background:#f9f9f9; padding:20px; border-radius:12px; display:grid; gap:10px"><div style="display:flex; justify-content:flex-end"><button class="btn-add" style="font-size:0.8rem" onclick="window.copyBankData('${item.name}', '${data.holder||'-'}', '${data.agency}', '${data.account}', '${data.pix}')"><i data-lucide="copy"></i> Copiar</button></div><div><small style="text-transform:uppercase; color:#999">Banco</small><div style="font-weight:600">${item.name}</div></div><div><small style="text-transform:uppercase; color:#999">Agência</small><div style="font-weight:600">${data.agency}</div></div><div><small style="text-transform:uppercase; color:#999">Conta</small><div style="font-weight:600">${data.account}</div></div><div><small style="text-transform:uppercase; color:#999">PIX</small><div style="font-weight:600">${data.pix}</div></div><button class="btn-cancel" onclick="alert('${data.pass}')" style="margin-top:10px"><i data-lucide="eye"></i> Senha</button></div>`;
        } else if (item.type === 'social') {
            const data = item.content;
            content = `<div style="background:#f9f9f9; padding:20px; border-radius:12px; display:grid; gap:10px">${Object.entries(data).map(([k,v]) => k !== 'pass' ? `<div><small style="text-transform:uppercase; color:#999">${k}</small><div style="font-weight:600">${v}</div></div>` : '').join('')}<button class="btn-cancel" onclick="alert('${data.pass}')" style="margin-top:10px"><i data-lucide="eye"></i> Senha</button></div>`;
        }
        el.innerHTML = `<div class="section-header"><h2>${item.name}</h2><div style="display:flex; gap:10px"><button class="btn-cancel" onclick="window.goBack()">Voltar</button><button class="btn-add" onclick="window.editItem('${item.id}', '${item.type}')">Editar</button></div></div><div class="card" style="display:block; cursor:default">${content}</div>`;
    };

    window.toggleWeightView = () => { state.weightExpanded = !state.weightExpanded; render(); };
    window.openWeightHistory = () => {
        const weightItem = state.items.find(i => i.type === 'health_weight');
        if (!weightItem || !weightItem.content.history) return;
        const history = [...weightItem.content.history].sort((a,b) => new Date(b.date) - new Date(a.date));
        const overlay = document.getElementById('modal-overlay');
        const form = document.getElementById('modal-form');
        const actions = document.getElementById('modal-actions');
        document.getElementById('modal-title').innerText = "Histórico de Peso";
        const listHtml = history.length ? history.map((h, index) => `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #eee"><div><div style="font-weight:600">${new Date(h.date).toLocaleDateString()}</div></div><div style="display:flex; align-items:center; gap:15px"><span style="font-weight:bold; color:var(--chocolate)">${h.weight} kg</span><i data-lucide="edit-2" style="width:18px; color:var(--chocolate); cursor:pointer" onclick="window.editWeightHistoryItem(${index})"></i><i data-lucide="trash-2" style="width:18px; color:var(--danger); cursor:pointer" onclick="window.deleteWeightHistoryItem(${index})"></i></div></div>`).join('') : '<div style="padding:20px; text-align:center; opacity:0.5">Sem registros.</div>';
        form.innerHTML = `<div style="max-height:400px; overflow-y:auto">${listHtml}</div>`;
        actions.innerHTML = `<button class="btn-cancel" onclick="window.closeModal()">Fechar</button>`;
        overlay.style.display = 'flex'; setTimeout(() => { overlay.classList.add('open'); if(window.lucide) window.lucide.createIcons(); }, 10);
    };
    
    window.editWeightHistoryItem = (index) => { state.editingHistoryIndex = index; window.closeModal(); setTimeout(() => window.openModal('weight_history_edit'), 300); };
    window.deleteWeightHistoryItem = async (index) => {
        if (!confirm("Excluir?")) return;
        const wItem = state.items.find(i => i.type === 'health_weight');
        let history = [...wItem.content.history].sort((a,b) => new Date(b.date) - new Date(a.date));
        history.splice(index, 1);
        let newCurrent = history.length > 0 ? history[0].weight : wItem.content.startWeight;
        const ref = isOffline ? {id: wItem.id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', wItem.id);
        await _updateDoc(ref, { 'content.history': history, 'content.current': newCurrent });
        window.closeModal(); window.showToast("Excluído.");
    };
    window.toggleMenstrualView = () => { state.menstrualView = state.menstrualView ? null : new Date(); render(); };
    window.changeCalMonth = (d) => { 
        if(!state.menstrualView) state.menstrualView = new Date();
        state.menstrualView.setMonth(state.menstrualView.getMonth() + d); 
        render(); 
    };
    
    // --- Modal Logic ---
    window.toggleCreateMenu = (btn) => { const menu = btn.nextElementSibling; document.querySelectorAll('.create-menu-dropdown').forEach(m => m.classList.remove('show')); if(!menu.classList.contains('show')) menu.classList.add('show'); event.stopPropagation(); };
    window.toggleActionMenu = (id) => { const menu = document.getElementById(`action-menu-${id}`); document.querySelectorAll('.create-menu-dropdown').forEach(m => m.classList.remove('show')); if(!menu.classList.contains('show')) menu.classList.add('show'); };
    document.addEventListener('click', () => document.querySelectorAll('.create-menu-dropdown').forEach(m => m.classList.remove('show')));

    // Helper for IBGE Cities
    window.loadCities = async (uf) => {
        const citySelect = document.getElementById('f-gps-city');
        citySelect.innerHTML = '<option>Carregando...</option>';
        try {
            const res = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`);
            const cities = await res.json();
            citySelect.innerHTML = cities.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
        } catch(e) { citySelect.innerHTML = '<option>Erro</option>'; }
    };
    
    window.closeModal = () => {
        const m = document.getElementById('modal-overlay');
        m.classList.remove('open'); setTimeout(() => m.style.display = 'none', 300);
        state.editingId = null;
    };

    window.openModal = (type, editingId = null) => {
        const overlay = document.getElementById('modal-overlay');
        const form = document.getElementById('modal-form');
        const actions = document.getElementById('modal-actions');
        state.editingId = editingId;
        
        let html = '';
        let title = editingId ? 'Editar' : 'Novo';
        if (type === 'rename') title = 'Renomear';
        
        const inp = (id, lbl, pl, val='') => `<div class="form-group"><label>${lbl}</label><input type="text" id="${id}" class="form-control" placeholder="${pl}" value="${val}"></div>`;
        const item = editingId ? state.items.find(i=>i.id===editingId) : null;
        const v = (key) => item && item.content ? item.content[key] || '' : '';
        const n = () => item ? item.name : '';

        switch(type) {
            case 'create_area': title = 'Nova Área'; html = inp('f-name', 'Nome da Área', 'Ex: Projetos'); break;
            case 'rename': html = inp('f-name', 'Novo Nome', '', n()); break;
            case 'folder': html = inp('f-name', 'Nome da Pasta', '', n()); break;
            case 'note': html = inp('f-name', 'Título', '', n()) + `<div class="form-group"><label>Conteúdo</label><textarea id="f-text" class="form-control">${v('text')}</textarea></div>`; break;
            case 'file': html = inp('f-name', 'Nome', '', n()) + `<div class="form-group"><label>Arquivo</label><input type="file" id="f-file" class="form-control"></div>` + `<div class="form-group"><label>Legenda</label><input type="text" id="f-caption" class="form-control" value="${v('caption')}"></div>`; break;
            case 'checklist': case 'checklist_sum': html = inp('f-name', 'Título', '', n()); break;
            case 'bank': html = inp('f-name', 'Banco', '', n()) + inp('f-holder', 'Titular', '', v('holder')) + inp('f-ag', 'Agência', '', v('agency')) + inp('f-cc', 'Conta', '', v('account')) + inp('f-pix', 'PIX', '', v('pix')) + inp('f-pass', 'Senha', '', v('pass')); break;
            case 'social': html = inp('f-name','Plataforma','',n()) + inp('f-login','Login','',v('login')) + inp('f-pass','Senha','',v('pass')); break;
            case 'expense': case 'pendency': title = type === 'expense' ? 'Nova Despesa' : 'Nova Pendência'; html = inp('f-name', 'Descrição', 'Ex: Aluguel', n()) + `<div class="form-group"><label>Valor</label><input type="number" id="f-val" class="form-control" value="${v('value')}"></div>` + `<div class="form-group"><label>Parcelas</label><input type="number" id="f-par" class="form-control" value="1"></div>` + `<div class="form-group"><label>Vencimento</label><input type="date" id="f-due" class="form-control" value="${v('due') || new Date().toISOString().split('T')[0]}"></div>`; break;
            case 'piggy': html = inp('f-name', 'Objetivo', '', n()) + inp('f-target', 'Valor Alvo', '', v('target')) + inp('f-months', 'Meses', '', v('months')); break;
            case 'health_weight_config': title='Config Peso'; html = inp('f-w-start','Inicial',0,v('startWeight')) + inp('f-w-target','Meta',0,v('target')) + `<div class="form-group"><label>Início</label><input type="date" id="f-w-date" class="form-control" value="${v('startDate')||new Date().toISOString().split('T')[0]}"></div>` + inp('f-w-period','Meses',12,v('periodMonths')); break;
            case 'health_weight_register': html = `<div class="form-group"><label>Data</label><input type="date" id="f-reg-date" class="form-control" value="${new Date().toISOString().split('T')[0]}"></div>` + inp('f-reg-weight','Peso',0,''); break;
            case 'weight_history_edit':
                title = 'Editar Registro';
                const wItem = state.items.find(i => i.type === 'health_weight');
                let sortedHist = [...wItem.content.history].sort((a,b) => new Date(b.date) - new Date(a.date));
                const histItem = sortedHist[state.editingHistoryIndex];
                html = `<div class="form-group"><label>Data</label><input type="date" id="f-reg-date" class="form-control" value="${histItem.date}"></div>` + 
                       `<div class="form-group"><label>Peso (kg)</label><input type="number" id="f-reg-weight" class="form-control" value="${histItem.weight}"></div>`;
                break;
            case 'health_med': html = inp('f-name','Remédio','',n()) + inp('f-time','Horário','',v('time')) + inp('f-inst','Instruções','',v('instructions')); break;
            case 'health_food': title='Dieta'; html=`<div class="form-group"><textarea id="f-diet" class="form-control" style="height:200px">${v('text')}</textarea></div>`; break;
            case 'gps_settings': title = 'GPS Config'; html = `<div class="form-group"><label>Estado</label><select id="f-gps-state" class="form-control" onchange="window.loadCities(this.value)"><option value="SP">SP</option></select></div><div class="form-group"><label>Cidade</label><select id="f-gps-city" class="form-control"><option>São Paulo</option></select></div>`; setTimeout(()=>window.loadCities('SP'),100); break;
            case 'menstrual_log': 
                title = 'Ciclo'; 
                const dateKey = editingId; 
                const existingLog = state.items.find(i => i.type === 'menstrual_cycle' && i.content.date === dateKey);
                const flow = existingLog ? existingLog.content.flow : '';
                html = `<input type="hidden" id="f-mens-date" value="${dateKey}"><div style="text-align:center;margin-bottom:10px">${new Date(dateKey).toLocaleDateString()}</div><div class="form-group"><label>Fluxo</label><select id="f-mens-flow" class="form-control"><option value="">Nenhum</option><option value="Inicio" ${flow==='Inicio'?'selected':''}>Início</option><option value="Medio" ${flow==='Medio'?'selected':''}>Médio</option><option value="Intenso" ${flow==='Intenso'?'selected':''}>Intenso</option><option value="Leve" ${flow==='Leve'?'selected':''}>Leve</option></select></div><div class="form-group"><input type="checkbox" id="f-mens-sex" ${existingLog && existingLog.content.sex?'checked':''}> Sexo <input type="checkbox" id="f-mens-prot" ${existingLog && existingLog.content.protection?'checked':''}> Proteção</div><div class="form-group"><label>Notas</label><textarea id="f-mens-notes" class="form-control">${existingLog?existingLog.content.notes||'':''}</textarea></div>`;
                break;
            case 'menstrual_settings': 
                 title = 'Perfil Mulher';
                 const p = state.items.find(i=>i.type==='menstrual_profile')||{content:{}};
                 html = inp('f-prof-name','Nome','',p.content.name) + inp('f-prof-age','Idade','',p.content.age) + inp('f-prof-dur','Ciclo',28,p.content.cycleDuration) + inp('f-prof-flowdur','Fluxo',5,p.content.flowDuration) + `<div class="form-group"><label>Contraceptivo</label><select id="f-prof-contra" class="form-control"><option value="Nenhum" ${p.content.contraceptiveType==='Nenhum'?'selected':''}>Nenhum</option><option value="Pílula" ${p.content.contraceptiveType==='Pílula'?'selected':''}>Pílula</option><option value="Injeção" ${p.content.contraceptiveType==='Injeção'?'selected':''}>Injeção</option></select></div>` + inp('f-prof-contradate','Última Data','',p.content.lastContraDate);
                 break;
         }

        document.getElementById('modal-title').innerText = title;
        form.innerHTML = html;
        actions.innerHTML = `<button class="btn-cancel" onclick="window.closeModal()">Cancelar</button><button class="btn-add" onclick="window.saveItem('${type}')">Salvar</button>`;
        overlay.style.display = 'flex'; setTimeout(() => overlay.classList.add('open'), 10);
    };

    window.saveItem = async (type) => {
        const parentId = state.path[state.path.length - 1];
        const coll = isOffline ? null : collection(db, 'artifacts', appId, 'users', state.user.uid, 'items');
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
        const getCheck = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };
        let data = { parentId, type, createdAt: Date.now() };

        try {
            if (type === 'create_area') {
                data = { type: 'custom_area', name: getVal('f-name'), parentId: 'root', createdAt: Date.now() };
                await _addDoc(coll, data);
            } else if (type === 'rename') {
                const ref = isOffline ? {id: state.editingId} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', state.editingId);
                await _updateDoc(ref, { name: getVal('f-name') });
            } else if (type === 'file') {
                 const f = document.getElementById('f-file').files[0];
                 const caption = getVal('f-caption');
                 const name = getVal('f-name');
                 
                 if(f) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const fileData = { name: name || f.name, type: 'file', content: {data:e.target.result, fileType:f.type, caption: caption}, createdAt: Date.now(), parentId };
                        if (state.editingId) await _updateDoc(isOffline ? {id: state.editingId} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', state.editingId), fileData);
                        else await _addDoc(coll, fileData);
                        state.editingId = null; window.closeModal(); window.showToast("Arquivo salvo!");
                    };
                    reader.readAsDataURL(f); return;
                 } else if (state.editingId) {
                     const ref = isOffline ? {id: state.editingId} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', state.editingId);
                     await _updateDoc(ref, { name: name, 'content.caption': caption });
                 }
            } 
            else if (type === 'folder') { data.name = getVal('f-name'); await _addDoc(coll, data); }
            else if (type === 'note') { data.name = getVal('f-name'); data.content = {text: getVal('f-text')}; if(state.editingId) await _updateDoc(isOffline?{id:state.editingId}:doc(db,'artifacts',appId,'users',state.user.uid,'items',state.editingId), data); else await _addDoc(coll, data); }
            else if (type.includes('checklist')) { data.name = getVal('f-name'); if(!state.editingId) data.content = { items: [] }; if(state.editingId) { const docRef = isOffline ? {id: state.editingId} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', state.editingId); delete data.content; await _updateDoc(docRef, data); } else await _addDoc(coll, data); }
            else if (type === 'bank') { data.name = getVal('f-name'); data.content = { holder: getVal('f-holder'), agency: getVal('f-ag'), account: getVal('f-cc'), pix: getVal('f-pix'), pass: getVal('f-pass') }; if(state.editingId) { const docRef = isOffline ? {id: state.editingId} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', state.editingId); await _updateDoc(docRef, data); } else await _addDoc(coll, data); }
            else if (type === 'social') { data.name = getVal('f-name'); data.content = { login: getVal('f-login'), pass: getVal('f-pass') }; if(state.editingId) { const docRef = isOffline ? {id: state.editingId} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', state.editingId); await _updateDoc(docRef, data); } else await _addDoc(coll, data); }
            
            else if (type === 'expense' || type === 'pendency') {
                const name = getVal('f-name');
                const totalVal = parseFloat(getVal('f-val'));
                const parcels = parseInt(getVal('f-par')) || 1;
                const dueStr = getVal('f-due');
                const parcelVal = totalVal / parcels;
                for(let i=0; i<parcels; i++) {
                    const date = new Date(dueStr + 'T12:00:00');
                    date.setMonth(date.getMonth() + i);
                    await _addDoc(coll, { parentId, type, name: parcels > 1 ? `${name} (${i+1}/${parcels})` : name, createdAt: Date.now() + i, content: { value: parcelVal, due: date.toISOString().split('T')[0], paid: false } });
                }
            }
            else if (type === 'piggy') {
                data.name = getVal('f-name');
                data.content = { target: getVal('f-target'), months: getVal('f-months'), saved: state.editingId ? state.items.find(i=>i.id===state.editingId).content.saved : 0 };
                if(state.editingId) await _updateDoc(isOffline?{id:state.editingId}:doc(db,'artifacts',appId,'users',state.user.uid,'items',state.editingId), data); else await _addDoc(coll, data);
            }
            else if(type === 'health_weight_config') {
                 const startW = getVal('f-w-start'); const targetW = getVal('f-w-target');
                 if(state.editingId) await _updateDoc(isOffline?{id:state.editingId}:doc(db,'artifacts',appId,'users',state.user.uid,'items',state.editingId), { 'content.startWeight': startW, 'content.target': targetW, 'content.startDate': getVal('f-w-date'), 'content.periodMonths': getVal('f-w-period') });
                 else await _addDoc(coll, { parentId: 'saude', type: 'health_weight', name: 'Peso', content: { current: startW, startWeight: startW, target: targetW, startDate: getVal('f-w-date'), periodMonths: getVal('f-w-period'), history: [] } });
            }
            else if(type === 'health_weight_register') { 
                const regW = parseFloat(getVal('f-reg-weight'));
                const wItem = state.items.find(i => i.type === 'health_weight');
                await _updateDoc(isOffline?{id:wItem.id}:doc(db,'artifacts',appId,'users',state.user.uid,'items',wItem.id), { 'content.current': regW, 'content.history': [...wItem.content.history, { date: getVal('f-reg-date'), weight: regW }] });
            }
            else if(type === 'weight_history_edit') {
                const wItem = state.items.find(i => i.type === 'health_weight');
                let history = [...wItem.content.history].sort((a,b) => new Date(b.date) - new Date(a.date));
                history[state.editingHistoryIndex] = { date: getVal('f-reg-date'), weight: parseFloat(getVal('f-reg-weight')) };
                history.sort((a,b) => new Date(b.date) - new Date(a.date));
                const newCurrent = history.length > 0 ? history[0].weight : wItem.content.startWeight;
                await _updateDoc(isOffline?{id:wItem.id}:doc(db,'artifacts',appId,'users',state.user.uid,'items',wItem.id), { 'content.history': history, 'content.current': newCurrent });
            }
            else if(type === 'health_med') { data.name = getVal('f-name'); data.content = { time: getVal('f-time'), instructions: getVal('f-inst') }; if(state.editingId) await _updateDoc(isOffline?{id:state.editingId}:doc(db,'artifacts',appId,'users',state.user.uid,'items',state.editingId), data); else await _addDoc(coll, data); }
            else if(type === 'health_food') { 
                const txt = getVal('f-diet'); const ex = state.items.find(i=>i.type==='health_food');
                if(ex) await _updateDoc(isOffline?{id:ex.id}:doc(db,'artifacts',appId,'users',state.user.uid,'items',ex.id), {'content.text': txt});
                else await _addDoc(coll, {parentId:'saude', type:'health_food', name:'Dieta', content:{text:txt}});
            }
            else if(type === 'gps_settings') {
                const uf = document.getElementById('f-gps-state').value; const city = document.getElementById('f-gps-city').value;
                const newSettings = { defaultCity: {lat: -23.5505, lng: -46.6333}, cityName: `${city} - ${uf}`, state: uf };
                const ex = state.items.find(i => i.type === 'gps_settings');
                if(ex) await _updateDoc(isOffline?{id:ex.id}:doc(db,'artifacts',appId,'users',state.user.uid,'items',ex.id), {content: newSettings});
                else await _addDoc(coll, {parentId: 'saude', type: 'gps_settings', name: 'GPS Settings', content: newSettings});
            }
            else if(type === 'menstrual_log') {
                const dateKey = getVal('f-mens-date');
                const content = { date: dateKey, flow: getVal('f-mens-flow'), sex: getCheck('f-mens-sex'), protection: getCheck('f-mens-prot'), notes: getVal('f-mens-notes') };
                const existing = state.items.find(i => i.type === 'menstrual_cycle' && i.content.date === dateKey);
                if (existing) await _updateDoc(isOffline ? {id: existing.id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', existing.id), {content});
                else await _addDoc(coll, { parentId: 'saude', type: 'menstrual_cycle', name: 'Ciclo', content });
                render();
            }
            else if(type === 'menstrual_settings') {
                const content = { name: getVal('f-prof-name'), age: getVal('f-prof-age'), cycleDuration: getVal('f-prof-dur'), flowDuration: getVal('f-prof-flowdur'), contraceptiveType: getVal('f-prof-contra'), lastContraDate: getVal('f-prof-contradate'), contraceptiveTime: getVal('f-prof-time') };
                const existing = state.items.find(i => i.type === 'menstrual_profile');
                if(existing) await _updateDoc(isOffline ? {id: existing.id} : doc(db, 'artifacts', appId, 'users', state.user.uid, 'items', existing.id), {content});
                else await _addDoc(coll, { parentId: 'saude', type: 'menstrual_profile', name: 'Perfil Mulher', content });
                render();
            }

            window.showToast("Salvo!"); window.closeModal();
        } catch(e) { console.error(e); window.showToast("Erro: " + e.message, "error"); }
    };
    
    initApp();
</script>
</body><script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBdw18PXbqdO0jqSBNKSTxBKVZzVlweMC0",
    authDomain: "cm-planner-84079.firebaseapp.com",
    projectId: "cm-planner-84079",
    storageBucket: "cm-planner-84079.firebasestorage.app",
    messagingSenderId: "109535738114",
    appId: "1:109535738114:web:a055116180d54ffa312a1b"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
    <div id="logout-container" style="position: fixed; top: 15px; right: 15px; z-index: 999999;">
    <button id="btn-sair" style="background: #3E2723; color: #C5A059; border: 1px solid #C5A059; padding: 8px 15px; border-radius: 20px; font-size: 10px; font-weight: bold; cursor: pointer; font-family: 'Montserrat', sans-serif;">
        SAIR DO SISTEMA
    </button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBdw18PXbqdO0jqSBNKSTxBKVZzVlweMC0",
        authDomain: "cm-planner-84079.firebaseapp.com",
        projectId: "cm-planner-84079",
        storageBucket: "cm-planner-84079.firebasestorage.app",
        messagingSenderId: "109535738114",
        appId: "1:109535738114:web:19f07eae3077a496312a1b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // O GUARDA: Se não houver login ativo, expulsa para o login.html
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "login.html";
        } else {
            console.log("Acesso autorizado como: " + user.email);
        }
    });

    // BOTÃO SAIR
    document.getElementById('btn-sair').addEventListener('click', () => {
        signOut(auth).then(() => {
            window.location.href = "login.html";
        });
    });
</script>
</html>
